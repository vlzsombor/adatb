<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

    <head th:insert="fragments.html :: headerfiles"></head>



<body>

<script>
    function ajaxCall() {
        this.send = function(data, url, method, success, type) {
            type = type||'json';
            var successRes = function(data) {
                success(data);
            }

            var errorRes = function(e) {
                console.log(e);
                //alert("Error found \nError Code: "+e.status+" \nError Message: "+e.statusText);
                //jQuery('#loader').modal('hide');
            }
            jQuery.ajax({
                url: url,
                type: method,
                data: data,
                success: successRes,
                error: errorRes,
                dataType: type,
                timeout: 60000
            });

        }

    }

    function locationInfo() {
        var rootUrl = "https://geodata.solutions/api/api.php";
        //now check for set values
        var addParams = '';
        if(jQuery("#gds_appid").length > 0) {
            addParams += '&appid=' + jQuery("#gds_appid").val();
        }
        if(jQuery("#gds_hash").length > 0) {
            addParams += '&hash=' + jQuery("#gds_hash").val();
        }

        var call = new ajaxCall();

        this.confCity = function(id) {
            //   console.log(id);
            //   console.log('started');
            var url = rootUrl+'?type=confCity&countryId='+ jQuery('#countryId option:selected').attr('countryid') +'&stateId=' + jQuery('#stateId option:selected').attr('stateid') + '&cityId=' + id;
            var method = "post";
            var data = {};
            call.send(data, url, method, function(data) {
                if(data){
                    //    alert(data);
                }
                else{
                    //   alert('No data');
                }
            });
        };


        this.getCities = function(id) {
            jQuery(".cities option:gt(0)").remove();
            //get additional fields
            var stateClasses = jQuery('#cityId').attr('class');

            var cC = stateClasses.split(" ");
            cC.shift();
            var addClasses = '';
            if(cC.length > 0)
            {
                acC = cC.join();
                addClasses = '&addClasses=' + encodeURIComponent(acC);
            }
            var url = rootUrl+'?type=getCities&countryId='+ jQuery('#countryId option:selected').attr('countryid') +'&stateId=' + id + addParams + addClasses;
            var method = "post";
            var data = {};
            jQuery('.cities').find("option:eq(0)").html("Please wait..");
            call.send(data, url, method, function(data) {
                jQuery('.cities').find("option:eq(0)").html("Select City");
                if(data.tp == 1){
                    var listlen = Object.keys(data['result']).length;

                    if(listlen > 0)
                    {
                        jQuery.each(data['result'], function(key, val) {

                            var option = jQuery('<option />');
                            option.attr('value', val).text(val);
                            jQuery('.cities').append(option);
                        });
                    }
                    else
                    {
                        var usestate = jQuery('#stateId option:selected').val();
                        var option = jQuery('<option />');
                        option.attr('value', usestate).text(usestate);
                        option.attr('selected', 'selected');
                        jQuery('.cities').append(option);
                    }

                    jQuery(".cities").prop("disabled",false);
                }
                else{
                    alert(data.msg);
                }
            });
        };

        this.getStates = function(id) {
            jQuery(".states option:gt(0)").remove();
            jQuery(".cities option:gt(0)").remove();
            //get additional fields
            var stateClasses = jQuery('#stateId').attr('class');

            var cC = stateClasses.split(" ");
            cC.shift();
            var addClasses = '';
            if(cC.length > 0)
            {
                acC = cC.join();
                addClasses = '&addClasses=' + encodeURIComponent(acC);
            }
            var url = rootUrl+'?type=getStates&countryId=' + id + addParams  + addClasses;
            var method = "post";
            var data = {};
            jQuery('.states').find("option:eq(0)").html("Please wait..");
            call.send(data, url, method, function(data) {
                jQuery('.states').find("option:eq(0)").html("Select State");
                if(data.tp == 1){
                    jQuery.each(data['result'], function(key, val) {
                        var option = jQuery('<option />');
                        option.attr('value', val).text(val);
                        option.attr('stateid', key);
                        jQuery('.states').append(option);
                    });
                    jQuery(".states").prop("disabled",false);
                }
                else{
                    alert(data.msg);
                }
            });
        };

        this.getCountries = function() {
            //get additional fields
            var countryClasses = jQuery('#countryId').attr('class');

            var cC = countryClasses.split(" ");
            cC.shift();
            var addClasses = '';
            if(cC.length > 0)
            {
                acC = cC.join();
                addClasses = '&addClasses=' + encodeURIComponent(acC);
            }

            var presel = false;
            var iip = 'N';
            jQuery.each(cC, function( index, value ) {
                if (value.match("^presel-")) {
                    presel = value.substring(7);

                }
                if(value.match("^presel-byi"))
                {
                    var iip = 'Y';
                }
            });


            var url = rootUrl+'?type=getCountries' + addParams + addClasses;
            var method = "post";
            var data = {};
            jQuery('.countries').find("option:eq(0)").html("Please wait..");
            call.send(data, url, method, function(data) {
                jQuery('.countries').find("option:eq(0)").html("Select Country");

                if(data.tp == 1){
                    if(presel == 'byip')
                    {
                        presel = data['presel'];
                        console.log('2 presel is set as ' + presel);
                    }


                    if(jQuery.inArray("group-continents",cC) > -1)
                    {
                        var $select = jQuery('.countries');
                        console.log(data['result']);
                        jQuery.each(data['result'], function(i, optgroups) {
                            var $optgroup = jQuery("<optgroup>", {label: i});
                            if(optgroups.length > 0)
                            {
                                $optgroup.appendTo($select);
                            }

                            jQuery.each(optgroups, function(groupName, options) {
                                var coption = jQuery('<option />');
                                coption.attr('value', options.name).text(options.name);
                                coption.attr('countryid', options.id);
                                if(presel) {
                                    if (presel.toUpperCase() == options.id) {
                                        coption.attr('selected', 'selected');
                                    }
                                }
                                coption.appendTo($optgroup);
                            });
                        });
                    }
                    else
                    {
                        jQuery.each(data['result'], function(key, val) {
                            var option = jQuery('<option />');
                            option.attr('value', val).text(val);
                            option.attr('countryid', key);
                            if(presel)
                            {
                                if(presel.toUpperCase() ==  key)
                                {
                                    option.attr('selected', 'selected');
                                }
                            }
                            jQuery('.countries').append(option);
                        });
                    }
                    if(presel)
                    {
                        jQuery('.countries').trigger('change');
                    }
                    jQuery(".countries").prop("disabled",false);
                }
                else{
                    alert(data.msg);
                }
            });
        };

    }

    jQuery(function() {
        var loc = new locationInfo();
        loc.getCountries();
        jQuery(".countries").on("change", function(ev) {
            var countryId = jQuery("option:selected", this).attr('countryid');
            if(countryId != ''){
                loc.getStates(countryId);
            }
            else{
                jQuery(".states option:gt(0)").remove();
            }
        });
        jQuery(".states").on("change", function(ev) {
            var stateId = jQuery("option:selected", this).attr('stateid');
            if(stateId != ''){
                loc.getCities(stateId);
            }
            else{
                jQuery(".cities option:gt(0)").remove();
            }
        });

        jQuery(".cities").on("change", function(ev) {
            var cityId = jQuery("option:selected", this).val();
            if(cityId != ''){
                loc.confCity(cityId);
            }
        });
    });
</script>

<div class="container">
    <div class="row">
        <div class="col-md-6 col-md-offset-3">

            <div th:if="${param.success}">
                <div class="alert alert-info">
                    You've successfully registered to our awesome app!
                </div>
            </div>

            <h1>Registration</h1>
            <form th:action="@{/registration}" th:object="${user}" method="post">

                <p class="error-message"
                   th:if="${#fields.hasGlobalErrors()}"
                   th:each="error : ${#fields.errors('global')}"
                   th:text="${error}">Validation error</p>

                <div class="form-group"
                     th:classappend="${#fields.hasErrors('firstName')}? 'has-error':''">
                    <label for="firstName" class="control-label">First name</label>
                    <input id="firstName"
                           class="form-control"
                           th:field="*{firstName}"/>
                    <p class="error-message"
                       th:each="error: ${#fields.errors('firstName')}"
                       th:text="${error}">Validation error</p>
                </div>
                <div class="form-group"
                     th:classappend="${#fields.hasErrors('lastName')}? 'has-error':''">
                    <label for="lastName" class="control-label">Last name</label>
                    <input id="lastName"
                           class="form-control"
                           th:field="*{lastName}"/>
                    <p class="error-message"
                       th:each="error : ${#fields.errors('lastName')}"
                       th:text="${error}">Validation error</p>
                </div>
                <div class="form-group"
                     th:classappend="${#fields.hasErrors('userName')}? 'has-error':''">
                    <label for="userName" class="control-label">User name</label>
                    <input id="userName"
                           class="form-control"
                           th:field="*{userName}"/>
                    <p class="error-message"
                       th:each="error : ${#fields.errors('userName')}"
                       th:text="${error}">Validation error</p>
                </div>
                <div class="form-group"
                     th:classappend="${#fields.hasErrors('mobileNumber')}? 'has-error':''">
                    <label for="mobileNumber" class="control-label">Mobilsz√°m</label>
                    <input id="mobileNumber"
                           class="form-control"
                           th:field="*{mobileNumber}"
                    type="number"/>
                    <p class="error-message"
                       th:each="error : ${#fields.errors('mobileNumber')}"
                       th:text="${error}">Validation error</p>
                </div>
                <div class="form-group"
                     th:classappend="${#fields.hasErrors('email')}? 'has-error':''">
                    <label for="email" class="control-label">E-mail</label>
                    <input id="email"
                           class="form-control"
                           th:field="*{email}"/>
                    <p class="error-message"
                       th:each="error : ${#fields.errors('email')}"
                       th:text="${error}">Validation error</p>
                </div>
                <div class="form-group"
                     th:classappend="${#fields.hasErrors('confirmEmail')}? 'has-error':''">
                    <label for="confirmEmail" class="control-label">Confirm e-mail</label>
                    <input id="confirmEmail"
                           class="form-control"
                           th:field="*{confirmEmail}"/>
                    <p class="error-message"
                       th:each="error : ${#fields.errors('confirmEmail')}"
                       th:text="${error}">Validation error</p>
                </div>
                <div class="form-group"
                     th:classappend="${#fields.hasErrors('password')}? 'has-error':''">
                    <label for="password" class="control-label">Password</label>
                    <input id="password"
                           class="form-control"
                           type="password"
                           th:field="*{password}"/>
                    <p class="error-message"
                       th:each="error : ${#fields.errors('password')}"
                       th:text="${error}">Validation error</p>
                </div>
                <div class="form-group"
                     th:classappend="${#fields.hasErrors('confirmPassword')}? 'has-error':''">
                    <label for="confirmPassword" class="control-label">Confirm password</label>
                    <input id="confirmPassword"
                           class="form-control"
                           type="password"
                           th:field="*{confirmPassword}"/>
                    <p class="error-message"
                       th:each="error : ${#fields.errors('confirmPassword')}"
                       th:text="${error}">Validation error</p>
                </div>
                <div class="form-group"
                     th:classappend="${#fields.hasErrors('terms')}? 'has-error':''">
                    <input id="terms"
                           type="checkbox"
                           th:field="*{terms}"/>
                    <label class="control-label" for="terms">
                        I agree with the <a href="#">terms and conditions</a> for Registration.
                    </label>
                    <p class="error-message"
                       th:each="error : ${#fields.errors('terms')}"
                       th:text="${error}">Validation error</p>
                </div>

                <div th:insert="fragments.html :: varos"></div>


                <div class="form-group">
                    <button type="submit" class="btn btn-success">Register</button>
                    <span>Already registered? <a href="/" th:href="@{/login}">Login here</a></span>
                </div>

            </form>
        </div>
    </div>
</div>

<script type="text/javascript" th:src="@{/webjars/jquery/3.2.1/jquery.min.js/}"></script>
<script type="text/javascript" th:src="@{/webjars/bootstrap/3.3.7/js/bootstrap.min.js}"></script>


</body>
</html>